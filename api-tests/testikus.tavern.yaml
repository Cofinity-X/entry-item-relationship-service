test_name: Make sure batch-job with several valid globalAssetIds has been requested correctly

strict:
  - headers:off
  - json:off

stages:
  - name: authenticate and fetch access token
    request:
      url: "{tavern.env_vars.KEYCLOAK_HOST}"
      method: POST
      data:
        grant_type: client_credentials
        client_id: "{tavern.env_vars.KEYCLOAK_CLIENT_ID}"
        client_secret: "{tavern.env_vars.KEYCLOAK_CLIENT_SECRET}"
    response:
      status_code: 200
      json:
        token_type: Bearer
      headers:
        content-type: application/json
      save:
        json:
          access_token: access_token

  - name: create a batch job with several valid globalAssetIds
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/orders"
      json:
        globalAssetIds:
          - urn:uuid:771d2ccc-a081-4d3a-bcb2-46c6a0a33743
          - urn:uuid:3db730be-9de5-4db5-a58d-684de36484e7
          - urn:uuid:73173bf5-08df-4898-9d6d-8899015c161e
          - urn:uuid:07e0997f-4212-4456-8f27-164b30fc8355
          - urn:uuid:88f51be1-3771-4335-8b5c-4c5050123127
          - urn:uuid:d3c0bf85-d44f-47c5-990d-fec8a36065c6
          - urn:uuid:a1082992-cc3b-4da1-af6b-aa692ed71461
          - urn:uuid:b21cfd5b-dcf4-46fa-9227-3eb693567dd8
          - urn:uuid:8f9d8c7f-6d7a-48f1-9959-9fa3a1a7a891
          - urn:uuid:ceb6b964-5779-49c1-b5e9-0ee70528fcbd
          - urn:uuid:a4a26b9c-9460-4cc5-8645-85916b86adb0
          - urn:uuid:7b87f5d6-f75e-40f1-a439-779ae9f57a21
          - urn:uuid:8914a66e-b59b-405f-afff-b97d71ebece3
          - urn:uuid:61a22b1c-5725-41fb-8e1e-dccaaba83838
          - urn:uuid:0ea1aa79-10d4-4df1-8a5a-5b7eafd26163
          - urn:uuid:1e35e091-3d3d-421e-9c7e-14cf1c9442a6
          - urn:uuid:cc8e9448-b294-46e7-8110-337e8bfa3001
          - urn:uuid:fa5804f1-8d4e-437c-aca2-a5491be61758
          - urn:uuid:a0f6803c-e4dc-4cda-8ad2-91cc57868449
          - urn:uuid:492781f5-62ff-4fb2-876c-3498e2844d13
          - urn:uuid:d6142601-5e09-45fe-9b42-e53cf8cd458c
        aspects:
          - "AssemblyPartRelationship"
          - "SerialPartTypization"
        collectAspects: true
        lookupBPNs: true
        batchSize: 10
        batchStrategy: "PRESERVE_BATCH_JOB_ORDER"
        depth: 1
        direction: "downward"
      method: POST
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token:s}"
    response:
      status_code: 201
      headers:
        content-type: application/json
      save:
        json:
          job_id: id

  - name: verify job response with desired test steps
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/orders/{job_id}"
      params:
        returnUncompletedJob: true
      method: GET
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token:s}"
    response:
      status_code: 200
      verify_response_with:
        function: api-tests.tavern_helpers:order_informations_for_batchprocessing_are_given
        extra_kwargs:
          amount_batches: 3
      headers:
        content-type: application/json


---


test_name: Make sure batch-job with invalid request data has been responsed correctly

strict:
  - headers:off
  - json:off

stages:
  - name: authenticate and fetch access token
    request:
      url: "{tavern.env_vars.KEYCLOAK_HOST}"
      method: POST
      data:
        grant_type: client_credentials
        client_id: "{tavern.env_vars.KEYCLOAK_CLIENT_ID}"
        client_secret: "{tavern.env_vars.KEYCLOAK_CLIENT_SECRET}"
    response:
      status_code: 200
      json:
        token_type: Bearer
      headers:
        content-type: application/json
      save:
        json:
          access_token: access_token

  - name: create a batch job with several valid globalAssetIds but invalid batchSize and check response
    request:
      url: "{tavern.env_vars.IRS_HOST}/irs/orders"
      json:
        globalAssetIds:
          - urn:uuid:771d2ccc-a081-4d3a-bcb2-46c6a0a33743
          - urn:uuid:3db730be-9de5-4db5-a58d-684de36484e7
          - urn:uuid:73173bf5-08df-4898-9d6d-8899015c161e
        aspects:
          - "AssemblyPartRelationship"
          - "SerialPartTypization"
        collectAspects: true
        lookupBPNs: true
        batchSize: 2
        batchStrategy: "PRESERVE_BATCH_JOB_ORDER"
        depth: 1
        direction: "downward"
      method: POST
      headers:
        content-type: application/json
        Authorization: "Bearer {access_token:s}"
    response:
      status_code: 400
      verify_response_with:
        function: api-tests.tavern_helpers:errors_for_invalid_batchSize_are_correct
      json:
        statusCode: BAD_REQUEST
        error: Invalid Arguments.
      headers:
        content-type: application/json
